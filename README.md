# MediaSnap

Screenshot and clip tool for Plex & Jellyfin. Capture moments from what you're watching on any device — TV, console, or phone — via a simple web UI.

## How it works

MediaSnap runs on the same server as your media stack. It polls Plex and Jellyfin to discover active playback sessions, then uses FFmpeg to extract frames or clips directly from the source media files on disk. No transcoding, no stream capture — full quality output in under a second.

## Quick Start (Docker)

**1. Clone and configure:**

```bash
git clone <repo-url> mediasnap && cd mediasnap
```

Edit `docker-compose.yml`:

- Set the media library volume to the same path your Plex/Jellyfin use (the path reported in their APIs must match inside the container).
- Set your Plex token and/or Jellyfin API key.

**2. Finding your tokens:**

- **Plex token:** In Plex Web, open any media item → Get Info → View XML → grab `X-Plex-Token` from the URL.
- **Jellyfin API key:** Dashboard → API Keys → Add.

**3. Launch:**

```bash
docker compose up -d --build
```

**4. Open** `http://your-server:8787` in a browser.

Start playing something on Plex or Jellyfin and it will appear in the Now Playing view. Tap Screenshot to capture the current frame, or tap Clip to extract a video clip of the last 10s–5m.

## Quick Start (Local Development)

**Backend:**
```bash
cd backend
python -m venv .venv && source .venv/bin/activate
pip install -r requirements.txt
```

Create `backend/.env`:
```env
PLEX_URL=http://localhost:32400
PLEX_TOKEN=your-plex-token
JELLYFIN_URL=http://localhost:8096
JELLYFIN_API_KEY=your-jellyfin-key
CAPTURE_DIR=../appdata/captures
DB_PATH=../appdata/mediasnap.db
```

```bash
uvicorn main:app --reload --port 8787
```

**Frontend (separate terminal):**
```bash
cd frontend
npm install
npm run dev
# Opens at http://localhost:5173, proxies API calls to :8787
```

## Configuration

All config is via environment variables or `.env` file:

| Variable | Default | Description |
|----------|---------|-------------|
| `PLEX_URL` | `""` | Plex server URL. Leave blank to disable Plex. |
| `PLEX_TOKEN` | `""` | Plex authentication token. |
| `JELLYFIN_URL` | `""` | Jellyfin server URL. Leave blank to disable Jellyfin. |
| `JELLYFIN_API_KEY` | `""` | Jellyfin API key. |
| `CAPTURE_DIR` | `/data/captures` | Where screenshots and clips are saved. |
| `DB_PATH` | `/data/mediasnap.db` | SQLite database path. |
| `FFMPEG_PATH` | `ffmpeg` | Path to FFmpeg binary. |
| `SCREENSHOT_QUALITY` | `2` | JPEG quality (1=best, 31=worst). |

You can configure just Plex, just Jellyfin, or both. Sources with blank URL or token are silently skipped.

## Important notes

**Media path mapping:** The media file paths reported by Plex/Jellyfin must resolve to the same absolute paths inside the MediaSnap container. If Plex says a file is at `/media/Movies/film.mkv`, MediaSnap must also see it at `/media/Movies/film.mkv`. The Docker volume mount handles this — just mount the same media directory.

**Security:** MediaSnap has no authentication on its web UI. It is designed for a trusted home network. Plex tokens and Jellyfin API keys are never sent to the browser — thumbnails are proxied server-side.

**FFmpeg:** Must be installed in the runtime environment. The Docker image includes it automatically.

## Project structure

```
mediasnap/
├── backend/
│   ├── main.py              # FastAPI app
│   ├── config.py            # Env-based configuration
│   ├── database.py          # SQLite setup
│   ├── models.py            # Pydantic models
│   ├── routers/
│   │   ├── sessions.py      # GET /api/sessions
│   │   ├── captures.py      # Screenshot/clip endpoints + gallery
│   │   └── proxy.py         # Thumbnail proxy (Plex + Jellyfin)
│   └── services/
│       ├── plex.py          # Plex API client
│       ├── jellyfin.py      # Jellyfin API client
│       ├── session_manager.py
│       └── ffmpeg.py        # FFmpeg wrapper
├── frontend/
│   └── src/
│       ├── App.tsx          # Main UI (Now Playing + Gallery)
│       ├── api.ts           # Typed API client
│       └── main.tsx         # Entry point
├── docker-compose.yml
├── Dockerfile
├── CONTEXT.md               # Full technical context for AI-assisted development
└── appdata/                 # Runtime: captures + SQLite DB
```

## API

| Method | Path | Description |
|--------|------|-------------|
| GET | `/api/sessions` | Active playback sessions |
| POST | `/api/capture/screenshot` | Capture a frame |
| POST | `/api/capture/clip` | Extract a video clip |
| GET | `/api/captures` | List all captures |
| GET | `/api/captures/{id}/file` | Download a capture |
| DELETE | `/api/captures/{id}` | Delete a capture |

Full API documentation is available at `http://your-server:8787/docs` (auto-generated by FastAPI).

## Roadmap

- [x] Phase 1: Screenshots from active playback sessions
- [x] Thumbnail proxy (no internal IPs or credentials leaked to client)
- [x] Phase 2: Video clip extraction UI
- [ ] Phase 3: Share links, auto-cleanup, Discord webhooks, subtitle burn-in